{"version":3,"sources":["../../src/crypto/crypto.js"],"names":["toMobileKey","password","privateKey","Error","salt","lib","WordArray","random","key","PBKDF2","keySize","iterations","iv","randomBytes","encIv","ua2words","encrypted","AES","encrypt","enc","Hex","parse","uint8ToHex","ciphertext","toString","derivePassSha","count","data","console","time","i","SHA3","outputLength","timeEnd","stringify","passwordToPrivatekey","common","walletAccount","algo","r","undefined","pass","obj","hexToUint8","priv","d","decrypt","isHW","hashfunc","dest","dataLength","convertedData","hash","words2ua","key_derive","shared","sk","pk","lowlevel","crypto_shared_key_hash","length","randomKey","rkey","encKey","encodePrivKey","_encode","senderPriv","recipientPub","msg","hexToUint8Reverse","Uint8Array","utf8ToHex","result","encode","encoded","decode","recipientPrivate","senderPublic","_payload","binPayload","buffer","payload","plain","hexplain","ua","uaLength","temp","x","push","create","destUa","cryptowords","v","words","module","exports"],"mappings":"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","file":"crypto.js","sourcesContent":["/*\n * Copyright 2018 NEM\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport convert from '../coders/convert';\nimport nacl from './nacl_catapult';\nimport CryptoJS from 'crypto-js';\n\n/**\n * Encrypt a private key for mobile apps (AES_PBKF2)\n *\n * @param {string} password - A wallet password\n * @param {string} privateKey - An account private key\n *\n * @return {object} - The encrypted data\n */\nlet toMobileKey = function(password, privateKey) {\n    // Errors\n    if (!password || !privateKey) throw new Error('Missing argument !');\n    //if (!Helpers.isPrivateKeyValid(privateKey)) throw new Error('Private key is not valid !');\n    // Processing\n    let salt = CryptoJS.lib.WordArray.random(256 / 8);\n    let key = CryptoJS.PBKDF2(password, salt, {\n        keySize: 256 / 32,\n        iterations: 2000\n    });\n    let iv = nacl.randomBytes(16)\n    let encIv = {\n        iv: ua2words(iv, 16)\n    };\n    let encrypted = CryptoJS.AES.encrypt(CryptoJS.enc.Hex.parse(privateKey), key, encIv);\n    // Result\n    return {\n        encrypted: convert.uint8ToHex(iv) + encrypted.ciphertext,\n        salt:  salt.toString()\n    }\n};\n\n/**\n * Derive a private key from a password using count iterations of SHA3-256\n *\n * @param {string} password - A wallet password\n * @param {number} count - A number of iterations above 0\n *\n * @return {object} - The derived private key\n */\nlet derivePassSha = function(password, count) {\n    // Errors\n    if(!password) throw new Error('Missing argument !');\n    if(!count || count <= 0) throw new Error('Please provide a count number above 0');\n    // Processing\n    let data = password;\n    console.time('sha3^n generation time');\n    for (let i = 0; i < count; ++i) {\n        data = CryptoJS.SHA3(data, {\n            outputLength: 256\n        });\n    }\n    console.timeEnd('sha3^n generation time');\n    // Result\n    return {\n        'priv': CryptoJS.enc.Hex.stringify(data)\n    };\n};\n\n/**\n * Reveal the private key of an account or derive it from the wallet password\n *\n * @param {object} common- An object containing password and privateKey field\n * @param {object} walletAccount - A wallet account object\n * @param {string} algo - A wallet algorithm\n *\n * @return {object|boolean} - The account private key in and object or false\n */\nlet passwordToPrivatekey = function(common, walletAccount, algo) {\n    // Errors\n    if(!common || !common.password || !walletAccount || !algo) throw new Error('Missing argument !');\n    // Processing\n    let r = undefined;\n    if (algo === \"pass:6k\") { // Brain wallets\n        if (!walletAccount.encrypted && !walletAccount.iv) {\n            // Account private key is generated simply using a passphrase so it has no encrypted and iv\n            r = derivePassSha(common.password, 6000);\n        } else if (!walletAccount.encrypted || !walletAccount.iv) {\n            // Else if one is missing there is a problem\n            //console.log(\"Account might be compromised, missing encrypted or iv\");\n            return false;\n        } else {\n            // Else child accounts have encrypted and iv so we decrypt\n            let pass = derivePassSha(common.password, 20);\n            let obj = {\n                ciphertext: CryptoJS.enc.Hex.parse(walletAccount.encrypted),\n                iv: convert.hexToUint8(walletAccount.iv),\n                key: convert.hexToUint8(pass.priv)\n            };\n            let d = decrypt(obj);\n            r = { 'priv': d };\n        }\n    } else if (algo === \"pass:bip32\") { // Wallets from PRNG\n        let pass = derivePassSha(common.password, 20);\n        let obj = {\n            ciphertext: CryptoJS.enc.Hex.parse(walletAccount.encrypted),\n            iv: convert.hexToUint8(walletAccount.iv),\n            key: convert.hexToUint8(pass.priv)\n        };\n        let d = decrypt(obj);\n        r = { 'priv': d };\n    } else if (algo === \"pass:enc\") { // Private Key wallets\n        let pass = derivePassSha(common.password, 20);\n        let obj = {\n            ciphertext: CryptoJS.enc.Hex.parse(walletAccount.encrypted),\n            iv: convert.hexToUint8(walletAccount.iv),\n            key: convert.hexToUint8(pass.priv)\n        };\n        let d = decrypt(obj);\n        r = { 'priv': d };\n    } else if (algo === \"trezor\") { // HW wallet\n        r = { 'priv': '' };\n        common.isHW = true;\n    } else {\n        //console.log(\"Unknown wallet encryption method\");\n        return false;\n    }\n    // Result\n    common.privateKey = r.priv;\n    return true;\n}\n\n\nfunction hashfunc(dest, data, dataLength) {\n    let convertedData = ua2words(data, dataLength);\n    let hash = CryptoJS.SHA3(convertedData, {\n        outputLength: 512\n    });\n    words2ua(dest, hash);\n}\n\nfunction key_derive(shared, salt, sk, pk) {\n    nacl.lowlevel.crypto_shared_key_hash(shared, pk, sk, hashfunc);\n    for (let i = 0; i < salt.length; i++) {\n        shared[i] ^= salt[i];\n    }\n    let hash = CryptoJS.SHA3(ua2words(shared, 32), {\n        outputLength: 256\n    });\n    return hash;\n}\n\n/**\n * Generate a random key\n *\n * @return {Uint8Array} - A random key\n */\nlet randomKey = function() {\n    let rkey = nacl.randomBytes(32)\n    return rkey;\n};\n\n/**\n * Encrypt hex data using a key\n *\n * @param {string} data - An hex string\n * @param {Uint8Array} key - An Uint8Array key\n *\n * @return {object} - The encrypted data\n */\nlet encrypt = function(data, key) {\n    // Errors\n    if (!data || !key) throw new Error('Missing argument !');\n    // Processing\n    let iv = nacl.randomBytes(16)\n    let encKey = ua2words(key, 32);\n    let encIv = {\n        iv: ua2words(iv, 16)\n    };\n    let encrypted = CryptoJS.AES.encrypt(CryptoJS.enc.Hex.parse(data), encKey, encIv);\n    // Result\n    return {\n        ciphertext: encrypted.ciphertext,\n        iv: iv,\n        key: key\n    };\n};\n\n/**\n * Decrypt data\n *\n * @param {object} data - An encrypted data object\n *\n * @return {string} - The decrypted hex string\n */\nlet decrypt = function(data) {\n    // Errors\n    if (!data) throw new Error('Missing argument !');\n    // Processing\n    let encKey = ua2words(data.key, 32);\n    let encIv = {\n        iv: ua2words(data.iv, 16)\n    };\n    // Result\n    return CryptoJS.enc.Hex.stringify(CryptoJS.AES.decrypt(data, encKey, encIv));\n};\n\n/**\n * Encode a private key using a password\n *\n * @param {string} privateKey - An hex private key\n * @param {string} password - A password\n *\n * @return {object} - The encoded data\n */\nlet encodePrivKey = function(privateKey, password) {\n    // Errors\n    if (!privateKey || !password) throw new Error('Missing argument !');\n    //if (!Helpers.isPrivateKeyValid(privateKey)) throw new Error('Private key is not valid !');\n    // Processing\n    let pass = derivePassSha(password, 20);\n    let r = encrypt(privateKey, convert.hexToUint8(pass.priv));\n    // Result\n    return {\n        ciphertext: CryptoJS.enc.Hex.stringify(r.ciphertext),\n        iv: convert.uint8ToHex(r.iv)\n    };\n};\n\n/***\n * Encode a message, separated from encode() to help testing\n *\n * @param {string} senderPriv - A sender private key\n * @param {string} recipientPub - A recipient public key\n * @param {string} msg - A text message\n * @param {Uint8Array} iv - An initialization vector\n * @param {Uint8Array} salt - A salt\n *\n * @return {string} - The encoded message\n */\nlet _encode = function(senderPriv, recipientPub, msg, iv, salt) {\n    // Errors\n    if (!senderPriv || !recipientPub || !msg || !iv || !salt) throw new Error('Missing argument !');\n    //if (!Helpers.isPrivateKeyValid(senderPriv)) throw new Error('Private key is not valid !');\n    //if (!Helpers.isPublicKeyValid(recipientPub)) throw new Error('Public key is not valid !');\n    // Processing\n    let sk = convert.hexToUint8Reverse(senderPriv);\n    let pk = convert.hexToUint8(recipientPub);\n    let shared = new Uint8Array(32);\n    let r = key_derive(shared, salt, sk, pk);\n    let encKey = r;\n    let encIv = {\n        iv: ua2words(iv, 16)\n    };\n    let encrypted = CryptoJS.AES.encrypt(CryptoJS.enc.Hex.parse(convert.utf8ToHex(msg)), encKey, encIv);\n    // Result\n    let result = convert.uint8ToHex(salt) + convert.uint8ToHex(iv) + CryptoJS.enc.Hex.stringify(encrypted.ciphertext);\n    return result;\n};\n\n/**\n * Encode a message\n *\n * @param {string} senderPriv - A sender private key\n * @param {string} recipientPub - A recipient public key\n * @param {string} msg - A text message\n *\n * @return {string} - The encoded message\n */\nlet encode = function(senderPriv, recipientPub, msg) {\n    // Errors\n    if (!senderPriv || !recipientPub || !msg) throw new Error('Missing argument !');\n    //if (!Helpers.isPrivateKeyValid(senderPriv)) throw new Error('Private key is not valid !');\n    //if (!Helpers.isPublicKeyValid(recipientPub)) throw new Error('Public key is not valid !');\n    // Processing\n    let iv = nacl.randomBytes(16)\n    //console.log(\"IV:\", convert.uint8ToHex(iv));\n    let salt = nacl.randomBytes(32)\n    let encoded = _encode(senderPriv, recipientPub, msg, iv, salt);\n    // Result\n    return encoded;\n};\n\n/**\n * Decode an encrypted message payload\n *\n * @param {string} recipientPrivate - A recipient private key\n * @param {string} senderPublic - A sender public key\n * @param {string} _payload - An encrypted message payload\n *\n * @return {string} - The decoded payload as hex\n */\nlet decode = function(recipientPrivate, senderPublic, _payload) {\n    // Errorsp\n    if(!recipientPrivate || !senderPublic || !_payload) throw new Error('Missing argument !');\n    //if (!Helpers.isPrivateKeyValid(recipientPrivate)) throw new Error('Private key is not valid !');\n    //if (!Helpers.isPublicKeyValid(senderPublic)) throw new Error('Public key is not valid !');\n    // Processing\n    let binPayload = convert.hexToUint8(_payload);\n    let salt = new Uint8Array(binPayload.buffer, 0, 32);\n    let iv = new Uint8Array(binPayload.buffer, 32, 16);\n    let payload = new Uint8Array(binPayload.buffer, 48);\n    let sk = convert.hexToUint8Reverse(recipientPrivate);\n    let pk = convert.hexToUint8(senderPublic);\n    let shared = new Uint8Array(32);\n    let r = key_derive(shared, salt, sk, pk);\n    let encKey = r;\n    let encIv = {\n        iv: ua2words(iv, 16)\n    };\n    let encrypted = {\n        'ciphertext': ua2words(payload, payload.length)\n    };\n    let plain = CryptoJS.AES.decrypt(encrypted, encKey, encIv);\n    // Result\n    let hexplain = CryptoJS.enc.Hex.stringify(plain);\n    return hexplain;\n};\n\n/**\n * Convert an Uint8Array to WordArray\n *\n * @param {Uint8Array} ua - An Uint8Array\n * @param {number} uaLength - The Uint8Array length\n *\n * @return {WordArray}\n */\nlet ua2words = function(ua, uaLength) {\n    let temp = [];\n    for (let i = 0; i < uaLength; i += 4) {\n        let x = ua[i] * 0x1000000 + (ua[i + 1] || 0) * 0x10000 + (ua[i + 2] || 0) * 0x100 + (ua[i + 3] || 0);\n        temp.push((x > 0x7fffffff) ? x - 0x100000000 : x);\n    }\n    return CryptoJS.lib.WordArray.create(temp, uaLength);\n}\n\n/**\n * Convert a wordArray to Uint8Array\n *\n * @param {Uint8Array} destUa - A destination Uint8Array\n * @param {WordArray} cryptowords - A wordArray\n *\n * @return {Uint8Array}\n */\nlet words2ua = function(destUa, cryptowords) {\n    for (let i = 0; i < destUa.length; i += 4) {\n        let v = cryptowords.words[i / 4];\n        if (v < 0) v += 0x100000000;\n        destUa[i] = (v >>> 24);\n        destUa[i + 1] = (v >>> 16) & 0xff;\n        destUa[i + 2] = (v >>> 8) & 0xff;\n        destUa[i + 3] = v & 0xff;\n    }\n    return destUa;\n}\n\nmodule.exports = {\n    toMobileKey,\n    derivePassSha,\n    passwordToPrivatekey,\n    randomKey,\n    decrypt,\n    encrypt,\n    encodePrivKey,\n    _encode,\n    encode,\n    decode\n}\n"]}